<!DOCTYPE html>
<!-- saved from url=(0039)https://www.mapmyroots.com/builder.html -->
<html lang="en" data-i18n-title="builder.meta.title"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title data-i18n="builder.meta.title">MapMyRoots - Build Your Family Tree</title>
  <meta name="description" content="Interactive family tree builder with drag-and-drop interface. Create, edit, and visualize your family connections with MapMyRoots." data-i18n-content="builder.meta.description">
  
  <!-- Google Tag Manager -->
  <script async="" src="./index_files/gtm.js.download"></script><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MNZ4MJB7');</script>
  <!-- End Google Tag Manager -->
  
  <!-- Google Fonts with optimized loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
  <link href="./index_files/css2" rel="stylesheet" media="all" onload="this.media=&#39;all&#39;">
  <noscript>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
  </noscript>
  <!-- Critical CSS variables to prevent FOUC -->
  <style>
    :root {
      --primary-color: #0f866c;
      --primary-dark: #0a6b56;
      --secondary-color: #2563eb;
      --text-primary: #2c3e50;
      --text-secondary: #7f8c8d;
      --background: #ffffff;
      --background-alt: #f8f9fa;
      --background-card: #ffffff;
      --border-color: #e9ecef;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }
    
    /* Prevent flash of unstyled content */
    body {
      font-family: var(--font-primary);
      background-color: var(--background);
      color: var(--text-primary);
      visibility: hidden;
    }
    
    /* Show body after fonts and styles are loaded */
    body.fonts-loaded {
      visibility: visible;
    }
    
    /* Disable animations until page is fully loaded */
    .no-animations * {
      animation-duration: 0s !important;
      animation-delay: 0s !important;
      transition-duration: 0s !important;
    }
  </style>
  
  <link rel="stylesheet" href="./index_files/style.css">
  <link rel="stylesheet" href="./index_files/modal.css">
  
  <!-- Language Switcher Styles -->
  <style>
    .language-switcher {
      position: relative;
      display: inline-block;
    }
    
    .language-button {
      background: none;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: var(--transition);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .language-button:hover {
      border-color: var(--primary-color);
      background: rgba(15, 134, 108, 0.05);
    }
    
    .language-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--background-card);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      box-shadow: var(--shadow);
      z-index: 1000;
      min-width: 150px;
      display: none;
    }
    
    .language-dropdown.open {
      display: block;
    }
    
    .language-option {
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: var(--transition);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      color: var(--text-primary);
    }
    
    .language-option:hover {
      background: var(--background-alt);
    }
    
    .language-option.active {
      background: rgba(15, 134, 108, 0.1);
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .language-flag {
      font-size: 1.2rem;
    }
  </style>
<style>
@keyframes slideUp {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-10px);
  }
}

@keyframes modalFadeOut {
  from {
    opacity: 1;
    backdrop-filter: blur(8px);
  }
  to {
    opacity: 0;
    backdrop-filter: blur(0px);
  }
}

.modal-closing .modal-content {
  animation: modalSlideOut 0.3s ease-in forwards;
}

@keyframes modalSlideOut {
  from {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  to {
    transform: translateY(-20px) scale(0.95);
    opacity: 0;
  }
}
</style><style id="modal-enhancement-styles">
      /* Modal Enhancement Styles */
      .modal-enhanced {
        backdrop-filter: blur(4px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .modal-enhanced .modal-content {
        transform: scale(0.9);
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .modal-enhanced:not(.hidden) .modal-content {
        transform: scale(1);
        opacity: 1;
      }

      .modal-closing .modal-content {
        transform: scale(0.9);
        opacity: 0;
      }

      .form-actions-enhanced {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .form-actions-right {
        display: flex;
        gap: 8px;
      }

      .button-enhanced {
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
      }

      .button-enhanced:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .button-enhanced:active {
        transform: translateY(0);
      }

      .button-enhanced.loading {
        pointer-events: none;
        opacity: 0.7;
      }

      .button-enhanced.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .gender-enhanced {
        display: flex;
        gap: 12px;
        margin: 16px 0;
      }

      .gender-radio-option {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        position: relative;
      }

      .gender-radio-option:hover {
        border-color: #3b82f6;
        background-color: #f8fafc;
      }

      .gender-radio-option.selected {
        border-color: #3b82f6;
        background-color: #eff6ff;
        color: #1d4ed8;
      }

      .gender-radio-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .form-group.focused {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group.error {
        border-color: #ef4444;
      }

      .error-message {
        color: #ef4444;
        font-size: 14px;
        margin-top: 4px;
      }

      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: scale(0);
        animation: ripple 0.6s ease-out;
        pointer-events: none;
      }

      @keyframes ripple {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .skip-link:focus {
        top: 6px !important;
      }

      /* Mobile optimizations */
      @media (max-width: 768px) {
        .modal-enhanced .modal-content {
          margin: 16px 16px 24px 16px;
          max-height: calc(100dvh - 96px);
          max-height: calc(100vh - 96px);
          max-height: calc(100svh - 96px);
          width: calc(100vw - 32px);
        }

        .form-actions-enhanced {
          flex-direction: column-reverse;
          gap: 12px;
        }

        .form-actions-right {
          width: 100%;
          flex-direction: column;
        }

        .gender-enhanced {
          flex-direction: column;
        }
      }
      
      @media (max-width: 480px) {
        .modal-enhanced .modal-content {
          margin: 16px 16px 30px 16px;
          max-height: calc(100dvh - 120px);
          max-height: calc(100vh - 120px);
          max-height: calc(100svh - 120px);
          width: calc(100vw - 32px);
        }
      }
    </style></head>
<body class="fonts-loaded">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MNZ4MJB7"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <!-- Enhanced Cache Indicator with Expandable Info -->
  <div class="cache-indicator" id="cacheIndicator">
    <div class="cache-save-indicator" id="saveIndicator" data-i18n="builder.cache.auto_save" style="color: rgb(39, 174, 96);">Last saved: 11:25:44 PM</div>
    <div class="cache-expanded-content">
      <input type="text" class="tree-name-input" id="treeNameInput" placeholder="Enter tree name..." value="My Family Tree" data-i18n-placeholder="builder.cache.tree_name_placeholder">
      <div class="tree-stats">
        <div>üë• <span id="personCount">107</span> <span data-i18n="builder.cache.people">people</span></div>
        <div>üîó <span id="connectionCount">174</span> <span data-i18n="builder.cache.connections">connections</span></div>
        <div>üíæ <span data-i18n="builder.cache.auto_save_status">Auto-save:</span> <span id="autoSaveStatus" data-i18n="builder.cache.enabled">enabled</span></div>
      </div>
    </div>
  </div>


  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="modal hidden modal-enhanced modal-enhanced-processed" role="dialog" aria-modal="true">
    <div class="modal-content confirmation-modal" style="scroll-behavior: smooth; overflow-y: auto; max-height: 80vh;">
      <button class="modal-close-btn" aria-label="Close">√ó</button>
      <div class="modal-header"><h2>
        <span class="person-icon">üóëÔ∏è</span>
        <span data-i18n="builder.modals.delete_person.title">Delete Person</span>
      </h2></div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="warning-icon">‚ö†Ô∏è</div>
          <p class="confirmation-message" data-i18n="builder.modals.delete_person.message">Are you sure you want to delete this person? This action cannot be undone.</p>
          <div class="consequence-list">
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>Personal information will be permanently lost</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>Family connections will be removed</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>This action cannot be undone</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions form-actions-enhanced">
        <div class="form-actions-right">
          <button type="button" id="cancelDeletePerson" data-i18n="builder.buttons.cancel" class="button-enhanced" aria-label="Cancel">Cancel</button>
          <button type="button" id="confirmDeletePerson" data-i18n="builder.modals.delete_person.confirm" class="button-enhanced" aria-label="Yes, Delete">Yes, Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Clear All Confirmation Modal -->
  <div id="clearAllConfirmModal" class="modal hidden modal-enhanced modal-enhanced-processed" role="dialog" aria-modal="true">
    <div class="modal-content confirmation-modal" style="scroll-behavior: smooth; overflow-y: auto; max-height: 80vh;">
      <button class="modal-close-btn" aria-label="Close">√ó</button>
      <div class="modal-header"><h2>
        <span class="person-icon">üîÑ</span>
        <span data-i18n="builder.modals.clear_all.title">Clear All Data</span>
      </h2></div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="warning-icon">‚ö†Ô∏è</div>
          <p class="confirmation-message" data-i18n="builder.modals.clear_all.message">Are you sure you want to clear all family tree data? This action cannot be undone.</p>
          <div class="consequence-list">
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>All family members will be deleted</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>All relationships will be lost</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>Your entire family tree will be reset</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions form-actions-enhanced">
        <div class="form-actions-right">
          <button type="button" id="cancelClearAll" data-i18n="builder.buttons.cancel" class="button-enhanced" aria-label="Cancel">Cancel</button>
          <button type="button" id="confirmClearAll" data-i18n="builder.modals.clear_all.confirm" class="button-enhanced" aria-label="Yes, Clear All">Yes, Clear All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load Default Tree Confirmation Modal -->
  <div id="loadDefaultConfirmModal" class="modal hidden modal-enhanced modal-enhanced-processed" role="dialog" aria-modal="true">
    <div class="modal-content confirmation-modal" style="scroll-behavior: smooth; overflow-y: auto; max-height: 80vh;">
      <button class="modal-close-btn" aria-label="Close">√ó</button>
      <div class="modal-header"><h2>
        <span class="person-icon">üå≥</span>
        <span data-i18n="builder.modals.load_default.title">Load Default Tree</span>
      </h2></div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="warning-icon">‚ö†Ô∏è</div>
          <p class="confirmation-message" data-i18n="builder.modals.load_default.message">Are you sure you want to load the default family tree template? This will replace all current data with a 3-generation sample family tree.</p>
          <div class="consequence-list">
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>All current family members will be replaced</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>All existing relationships will be lost</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>A new 3-generation template will be loaded</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions form-actions-enhanced">
        <div class="form-actions-right">
          <button type="button" id="cancelLoadDefault" data-i18n="builder.buttons.cancel" class="button-enhanced" aria-label="Cancel">Cancel</button>
          <button type="button" id="confirmLoadDefault" class="btn-success button-enhanced" data-i18n="builder.modals.load_default.confirm" aria-label="Yes, Load Template">Yes, Load Template</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Line Removal Modal -->
  <div id="lineRemovalModal" class="modal hidden modal-enhanced modal-enhanced-processed" role="dialog" aria-modal="true">
    <div class="modal-content confirmation-modal" style="scroll-behavior: smooth; overflow-y: auto; max-height: 80vh;">
      <div class="modal-header"><h2>
        <span class="person-icon">üëÅÔ∏è</span>
        <span data-i18n="builder.modals.line_removal.title">Remove Connection Line</span>
      </h2></div>
      <div class="modal-body">
        <div class="confirmation-content">
          <div class="info-icon">‚ÑπÔ∏è</div>
          <p class="confirmation-message" data-i18n="builder.modals.line_removal.message">This will hide the visual connection line but preserve the relationship data. The family relationship will remain intact and can be restored later.</p>
          <div class="consequence-list">
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>Connection line will be hidden</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>Relationship data remains intact</span>
            </div>
            <div class="consequence-item">
              <span class="bullet">‚Ä¢</span>
              <span>Can be restored at any time</span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-actions form-actions-enhanced">
        <div class="form-actions-right">
          <button type="button" id="cancelLineRemoval" data-i18n="builder.buttons.cancel" class="button-enhanced" aria-label="Cancel">Cancel</button>
          <button type="button" id="confirmLineRemoval" data-i18n="builder.modals.line_removal.confirm" class="button-enhanced" aria-label="Hide Line">Hide Line</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Container -->
  <div class="notifications-container" id="notificationsContainer"></div>

  <!-- Search Container -->
  <div class="search-container" id="searchContainer">
    <input type="text" id="searchField" class="search-field" placeholder="Search family members..." data-i18n="builder.search.placeholder">
    <button class="search-close" id="searchClose">√ó</button>
    <div class="search-suggestions" id="searchSuggestions"></div>
  </div>

  <!-- Header with Language Switcher -->
  <div class="header-controls" style="position: fixed; top: 1rem; right: 1rem; z-index: 200; display: flex; gap: 1rem; align-items: center;">
    <!-- Language Switcher -->
    <div class="language-switcher" id="language-switcher">
      <button class="language-button" id="language-button" aria-label="Select language" aria-expanded="false">
        <span class="language-flag" id="current-flag">üá∫üá∏</span>
        <span id="current-language">EN</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6,9 12,15 18,9"></polyline>
        </svg>
      </button>
      <div class="language-dropdown" id="language-dropdown">
        <button class="language-option active" data-lang="en" data-flag="üá∫üá∏" aria-selected="true">
          <span class="language-flag">üá∫üá∏</span>
          <span data-i18n="languages.english">English</span>
        </button>
        <button class="language-option" data-lang="es" data-flag="üá™üá∏" aria-selected="false">
          <span class="language-flag">üá™üá∏</span>
          <span data-i18n="languages.spanish">Espa√±ol</span>
        </button>
        <button class="language-option" data-lang="ru" data-flag="üá∑üá∫" aria-selected="false">
          <span class="language-flag">üá∑üá∫</span>
          <span data-i18n="languages.russian">–†—É—Å—Å–∫–∏–π</span>
        </button>
        <button class="language-option" data-lang="de" data-flag="üá©üá™" aria-selected="false">
          <span class="language-flag">üá©üá™</span>
          <span data-i18n="languages.german">Deutsch</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Vertical Sidebar -->
  <div class="sidebar">
    <button class="sidebar-btn" id="homeBtn" data-i18n-title="builder.sidebar.home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9,22 9,12 15,12 15,22"></polyline>
      </svg>
    </button>
    
    <div class="sidebar-divider"></div>
    
    <button class="sidebar-btn" id="searchBtn" data-i18n-title="builder.sidebar.search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="M21 21l-4.35-4.35"></path>
      </svg>
    </button>
    
    <button class="sidebar-btn" id="centerSelectedBtn" data-i18n-title="builder.sidebar.center_selected">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="3" fill="currentColor"></circle>
        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"></path>
      </svg>
    </button>
    
    <div class="sidebar-divider"></div>
    
    <button class="sidebar-btn" id="settingsToggle" data-i18n-title="builder.sidebar.settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
    
    <button class="sidebar-btn" id="viewToggle" data-i18n-title="builder.sidebar.toggle_view">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="4" rx="1"></rect>
        <rect x="3" y="10" width="18" height="4" rx="1"></rect>
        <rect x="3" y="17" width="18" height="4" rx="1"></rect>
      </svg>
    </button>
    
    <div class="sidebar-divider"></div>
    
    <!-- Undo/Redo buttons at bottom of sidebar -->
    <button class="sidebar-btn" id="undoSidebarBtn" data-i18n-title="builder.sidebar.undo" title="Nothing to undo" disabled="">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 7v6h6"></path>
        <path d="m21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
      </svg>
    </button>
    
    <button class="sidebar-btn" id="redoSidebarBtn" data-i18n-title="builder.sidebar.redo" title="Nothing to redo" disabled="">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 7v6h-6"></path>
        <path d="m3 17a9 9 0 019-9 9 9 0 016 2.3L21 13"></path>
      </svg>
    </button>
  </div>

  <!-- Enhanced Settings Panel -->
  <div id="settingsPanel" class="panel hidden">
    <button class="modal-close-btn" aria-label="Close">√ó</button>
    <h3 data-i18n="builder.settings.title">Family Tree Settings</h3>
    
    <!-- Node Style Selection -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="nodeStyleSection">
        <h4 data-i18n="builder.settings.node_style">Node Style</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="nodeStyleSection">
        <div class="node-style-grid">
          <div class="node-style-option selected" data-style="circle">
            <div class="node-style-preview circle">JD</div>
            <div class="node-style-label" data-i18n="builder.settings.style_circle">Circle</div>
          </div>
          <div class="node-style-option" data-style="rectangle">
            <div class="node-style-preview rectangle">John Doe</div>
            <div class="node-style-label" data-i18n="builder.settings.style_rectangle">Rectangle</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Display Preferences -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="displayPrefs">
        <h4 data-i18n="builder.settings.display_preferences">Display Preferences</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="displayPrefs">
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="showMaidenName" checked="">
            <label for="showMaidenName" data-i18n="builder.settings.show_maiden_name">Show Maiden Name</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="showDateOfBirth" checked="">
            <label for="showDateOfBirth" data-i18n="builder.settings.show_date_of_birth">Show Date of Birth</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="showFatherName" checked="">
            <label for="showFatherName" data-i18n="builder.settings.show_father_name">Show Father's Name</label>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Node Appearance -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="nodeAppearance">
        <h4 data-i18n="builder.settings.node_appearance">Node Appearance</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="nodeAppearance">
        <div class="setting-group">
          <label for="nodeColorPicker" data-i18n="builder.settings.node_color">Node Color:</label>
          <input type="color" id="nodeColorPicker" value="#3498db">
        </div>
        <div class="setting-group">
          <label for="nodeSizeInput" data-i18n="builder.settings.node_size">Node Size:</label>
          <input type="number" id="nodeSizeInput" min="10" max="100" value="40">
        </div>
        <div class="setting-group">
          <button id="applyNodeStyle" data-i18n="builder.settings.apply">Apply</button>
        </div>
      </div>
    </div>

    <!-- Node Outline -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="nodeOutline">
        <h4 data-i18n="builder.settings.node_outline">Node Outline</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="nodeOutline">
        <div class="setting-group">
          <div class="checkbox-item">
            <input type="checkbox" id="showNodeOutline" checked="">
            <label for="showNodeOutline" data-i18n="builder.settings.show_outline">Show Outline</label>
          </div>
        </div>
        <div class="setting-group">
          <label for="outlineThicknessInput" data-i18n="builder.settings.outline_thickness">Outline Thickness:</label>
          <input type="number" id="outlineThicknessInput" min="0" max="10" value="2">
        </div>
        <div class="setting-group">
          <label for="outlineColorPicker" data-i18n="builder.settings.outline_color">Outline Color:</label>
          <input type="color" id="outlineColorPicker" value="#2c3e50">
        </div>
        <div class="setting-group">
          <button id="applyOutlineStyle" data-i18n="builder.settings.apply">Apply</button>
        </div>
      </div>
    </div>

    <!-- Connector Lines -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="connectorLines">
        <h4 data-i18n="builder.settings.connector_lines">Connector Lines</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="connectorLines">
        <!-- Family Connection Lines -->
        <div class="setting-subsection">
          <h5 data-i18n="builder.settings.family_connections">Family Connections</h5>
          <div class="setting-group">
            <label for="familyLineStyleSelect" data-i18n="builder.settings.line_style">Line Style:</label>
            <select id="familyLineStyleSelect">
              <option value="solid" data-i18n="builder.settings.style_solid">Solid</option>
              <option value="dashed" data-i18n="builder.settings.style_dashed">Dashed</option>
              <option value="dotted" data-i18n="builder.settings.style_dotted">Dotted</option>
              <option value="dash-dot" data-i18n="builder.settings.style_dash_dot">Dash-Dot</option>
            </select>
          </div>
          <div class="setting-group">
            <label for="familyLineThicknessInput" data-i18n="builder.settings.line_thickness">Line Thickness:</label>
            <input type="number" id="familyLineThicknessInput" min="1" max="10" value="2">
          </div>
          <div class="setting-group">
            <label for="familyLineColorPicker" data-i18n="builder.settings.line_color">Line Color:</label>
            <input type="color" id="familyLineColorPicker" value="#7f8c8d">
          </div>
        </div>

        <!-- Spouse Connection Lines -->
        <div class="setting-subsection">
          <h5 data-i18n="builder.settings.spouse_connections">Spouse Connections</h5>
          <div class="setting-group">
            <label for="spouseLineStyleSelect" data-i18n="builder.settings.line_style">Line Style:</label>
            <select id="spouseLineStyleSelect">
              <option value="solid" data-i18n="builder.settings.style_solid">Solid</option>
              <option value="dashed" data-i18n="builder.settings.style_dashed">Dashed</option>
              <option value="dotted" data-i18n="builder.settings.style_dotted">Dotted</option>
              <option value="dash-dot" data-i18n="builder.settings.style_dash_dot">Dash-Dot</option>
            </select>
          </div>
          <div class="setting-group">
            <label for="spouseLineThicknessInput" data-i18n="builder.settings.line_thickness">Line Thickness:</label>
            <input type="number" id="spouseLineThicknessInput" min="1" max="10" value="2">
          </div>
          <div class="setting-group">
            <label for="spouseLineColorPicker" data-i18n="builder.settings.line_color">Line Color:</label>
            <input type="color" id="spouseLineColorPicker" value="#e74c3c">
          </div>
        </div>

        <!-- Line-Only Connections -->
        <div class="setting-subsection">
          <h5 data-i18n="builder.settings.line_only_connections">Line-Only Connections</h5>
          <div class="setting-group">
            <label for="lineOnlyStyleSelect" data-i18n="builder.settings.line_style">Line Style:</label>
            <select id="lineOnlyStyleSelect">
              <option value="solid" data-i18n="builder.settings.style_solid">Solid</option>
              <option value="dashed" data-i18n="builder.settings.style_dashed">Dashed</option>
              <option value="dotted" data-i18n="builder.settings.style_dotted">Dotted</option>
              <option value="dash-dot" data-i18n="builder.settings.style_dash_dot">Dash-Dot</option>
            </select>
          </div>
          <div class="setting-group">
            <label for="lineOnlyThicknessInput" data-i18n="builder.settings.line_thickness">Line Thickness:</label>
            <input type="number" id="lineOnlyThicknessInput" min="1" max="10" value="2">
          </div>
          <div class="setting-group">
            <label for="lineOnlyColorPicker" data-i18n="builder.settings.line_color">Line Color:</label>
            <input type="color" id="lineOnlyColorPicker" value="#9b59b6">
          </div>
        </div>

        <div class="setting-group">
          <button id="applyLineStyles" data-i18n="builder.settings.apply">Apply</button>
        </div>
      </div>
    </div>

    <!-- Text Settings -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="textSettings">
        <h4 data-i18n="builder.settings.text_settings">Text Settings</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="textSettings">
        <div class="setting-group">
          <label for="fontSelect" data-i18n="builder.settings.font">Font:</label>
          <select id="fontSelect">
            <optgroup label="Modern Sans-Serif">
              <option value="Inter">Inter</option>
              <option value="Roboto">Roboto</option>
              <option value="Lato">Lato</option>
              <option value="Montserrat">Montserrat</option>
              <option value="Poppins">Poppins</option>
              <option value="Open Sans">Open Sans</option>
            </optgroup>
            <optgroup label="Serif">
              <option value="Merriweather">Merriweather</option>
              <option value="Playfair Display">Playfair Display</option>
              <option value="Roboto Slab">Roboto Slab</option>
            </optgroup>
            <optgroup label="Monospace">
              <option value="Courier New">Courier New</option>
              <option value="Roboto Mono">Roboto Mono</option>
            </optgroup>
          </select>
        </div>
        <div class="setting-group">
          <label for="fontSizeInput" data-i18n="builder.settings.font_size">Font Size:</label>
          <input type="number" id="fontSizeInput" min="6" max="72" value="14">
        </div>
        <div class="setting-group">
          <label for="nameColorPicker" data-i18n="builder.settings.name_color">Name Color:</label>
          <input type="color" id="nameColorPicker" value="#333333">
        </div>
        <div class="setting-group">
          <label for="dateColorPicker" data-i18n="builder.settings.date_color">Date Color:</label>
          <input type="color" id="dateColorPicker" value="#757575">
        </div>
      </div>
    </div>

    <!-- Tree Shapes -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="treeShapes">
        <h4 data-i18n="builder.settings.tree_shapes">Tree Shapes</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="treeShapes">
        <div class="setting-group">
          <label for="shapeSelect" data-i18n="builder.settings.shape_layout">Layout Shape:</label>
          <select id="shapeSelect">
            <option value="none" data-i18n="builder.settings.shape_none">Manual Positioning</option>
            <option value="grape" data-i18n="builder.settings.shape_grape">Grape Bunch</option>
            <option value="treeBranches" data-i18n="builder.settings.shape_tree_branches">Tree Branches</option>
          </select>
        </div>
        
        <!-- Shape Options (will be populated dynamically) -->
        <div id="shapeOptions" class="shape-options"><p class="shape-help">Manual positioning allows you to freely drag and place family members anywhere on the canvas.</p></div>
        
        <div class="setting-group">
          <button id="applyShape" class="btn-primary" data-i18n="builder.settings.apply_shape">Apply Shape</button>
          <button id="resetToManual" class="btn-secondary" data-i18n="builder.settings.reset_to_manual">Reset to Manual</button>
        </div>
        
        <div class="setting-info" data-i18n="builder.settings.shape_info">Shapes automatically arrange family members based on genealogical relationships. Manual positioning allows free placement.</div>
      </div>
    </div>

    <!-- Data Management -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="dataManagement">
        <h4 data-i18n="builder.settings.data_management">Data Management</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="dataManagement">
        <!-- Enhanced Import/Export Area -->
        <div class="import-export-enhanced" id="importExportArea">
          <div class="setting-group">
            <button id="saveData" data-i18n="builder.settings.save_family_tree">Save Family Tree</button>
            <label for="loadData" class="file-label">
              <span data-i18n="builder.settings.load_family_tree">Load Family Tree</span>
              <input type="file" id="loadData" accept=".json">
            </label>
          </div>
          <div class="format-support" data-i18n="builder.settings.format_support">Supports JSON format files</div>
        </div>
        
        <!-- Auto-save Controls will be added here by JavaScript -->
      </div>
    </div>

    <!-- Reset -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-target="resetSection">
        <h4 data-i18n="builder.settings.reset">Reset</h4>
        <span class="collapsible-toggle">‚ñº</span>
      </div>
      <div class="collapsible-content" id="resetSection">
        <div class="setting-group">
          <button id="clearAllBtn" class="btn-danger-outline" data-i18n="builder.settings.clear_all_data">Clear All Data</button>
          <button id="loadDefaultBtn" class="btn-success-outline" data-i18n="builder.settings.load_default_tree">Load Default Tree</button>
        </div>
        <div class="format-support" data-i18n="builder.settings.clear_warning">Warning: This will permanently delete all family tree data</div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div id="mainContainer">
    <!-- Graphic View -->
    <div id="graphicView">
      
    <canvas style="width: 1463.43px; height: 786.286px; cursor: grab;" width="2561" height="1376"></canvas></div>

    <!-- Table View (initially hidden) -->
    <div id="tableView" class="hidden">
      <div id="tableControls">
        <input type="text" id="searchInput" placeholder="Search..." data-i18n="builder.table.search_placeholder">
        <select id="sortSelect">
          <option value="name" data-i18n="builder.table.sort_name">Name</option>
          <option value="fatherName" data-i18n="builder.table.sort_father_name">Father's Name</option>
          <option value="surname" data-i18n="builder.table.sort_surname">Surname</option>
          <option value="dob" data-i18n="builder.table.sort_dob">Date of Birth</option>
          <option value="gender" data-i18n="builder.table.sort_gender">Gender</option>
        </select>
      </div>
      <table id="familyTable">
        <thead>
          <tr>
            <th data-i18n="builder.table.header_name">Name</th>
            <th data-i18n="builder.table.header_father_name">Father's Name</th>
            <th data-i18n="builder.table.header_surname">Surname</th>
            <th data-i18n="builder.table.header_maiden_name">Maiden Name</th>
            <th data-i18n="builder.table.header_dob">Date of Birth</th>
            <th data-i18n="builder.table.header_gender">Gender</th>
            <th data-i18n="builder.table.header_mother">Mother</th>
            <th data-i18n="builder.table.header_father">Father</th>
            <th data-i18n="builder.table.header_spouse">Spouse</th>
            <th data-i18n="builder.table.header_actions">Actions</th>
          </tr>
        </thead>
        <tbody id="familyTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Zoom Controls (Bottom Right) -->
  <div class="zoom-controls">
    <button id="zoomOutControl" class="zoom-btn" title="Zoom Out (Ctrl + -)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
        <line x1="8" y1="11" x2="14" y2="11"></line>
      </svg>
    </button>
    <div class="zoom-display" id="zoomDisplay">100%</div>
    <button id="zoomInControl" class="zoom-btn" title="Zoom In (Ctrl + +)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
        <line x1="11" y1="8" x2="11" y2="14"></line>
        <line x1="8" y1="11" x2="14" y2="11"></line>
      </svg>
    </button>
  </div>

  <!-- Top Left Toolbar -->
  <div class="top-toolbar">
    <button id="saveBtn" class="toolbar-btn" title="Save Family Tree">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17,21 17,13 7,13 7,21"></polyline>
        <polyline points="7,3 7,8 15,8"></polyline>
      </svg>
    </button>
    <button id="loadBtn" class="toolbar-btn" title="Load Family Tree">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        <path d="M2 9h20"></path>
        <path d="M7 15l3-3-3-3"></path>
      </svg>
    </button>
    <button id="exportBtn" class="toolbar-btn" title="Export Family Tree">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7,10 12,15 17,10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    </button>
  </div>

  <!-- Export Menu -->
  <div id="exportMenu" class="export-menu hidden">
    <div class="export-option" data-format="svg">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="13,2 3,14 12,14 11,22 21,10 12,10"></polygon>
      </svg>
      <span>SVG</span>
    </div>
    <div class="export-option" data-format="png">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21,15 16,10 5,21"></polyline>
      </svg>
      <span>PNG</span>
    </div>
    <div class="export-option" data-format="png-transparent">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21,15 16,10 5,21"></polyline>
        <line x1="3" y1="21" x2="21" y2="3" stroke-dasharray="2,2"></line>
      </svg>
      <span>PNG (No BG)</span>
    </div>
    <div class="export-option" data-format="jpeg">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21,15 16,10 5,21"></polyline>
      </svg>
      <span>JPEG</span>
    </div>
    <div class="export-option" data-format="pdf">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14,2 14,8 20,8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10,9 9,9 8,9"></polyline>
      </svg>
      <span>PDF</span>
    </div>
    <div class="export-option" data-format="gedcom">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 6L9 17l-5-5"></path>
      </svg>
      <span>GEDCOM</span>
    </div>
  </div>

  <!-- Enhanced Floating Action Buttons with Bring to Front -->
  <div class="floating-buttons">
    <button id="bringFrontBtn" class="floating-btn bring-front hidden" data-i18n="builder.buttons.bring_front">FRONT</button>
    <button id="editBtn" class="floating-btn secondary hidden" data-i18n="builder.buttons.edit">Edit</button>
    <button id="styleBtn" class="floating-btn secondary hidden" data-i18n="builder.buttons.style">Style</button>
    <button id="connectBtn" class="floating-btn secondary hidden" data-i18n="builder.buttons.link">Link</button>
    <div class="main-buttons">
      <button id="addPersonBtn" class="floating-btn primary">+</button>
    </div>
  </div>

  <!-- Connection Modal - UPDATED with Line Only option -->
  <div id="connectionModal" class="modal hidden modal-enhanced modal-enhanced-processed" role="dialog" aria-modal="true">
    <div class="modal-content" style="scroll-behavior: smooth; overflow-y: auto; max-height: 80vh;">
      <button class="modal-close-btn" aria-label="Close">√ó</button>
      <div class="modal-header"><h2 id="connectionModalTitle" data-i18n="builder.modals.connection.title">Connect People</h2></div>
      <div class="connection-content">
        <p id="connectionText" data-i18n="builder.modals.connection.text">Person A is __ to Person B</p>
        <div class="connection-buttons">
          <button type="button" id="motherBtn" class="connection-btn" data-i18n="builder.modals.connection.mother">Mother</button>
          <button type="button" id="fatherBtn" class="connection-btn" data-i18n="builder.modals.connection.father">Father</button>
          <button type="button" id="childBtn" class="connection-btn" data-i18n="builder.modals.connection.child">Child</button>
          <button type="button" id="spouseBtn" class="connection-btn" data-i18n="builder.modals.connection.spouse">Spouse</button>
          <button type="button" id="lineOnlyBtn" class="connection-btn line-only" data-i18n="builder.modals.connection.line_only">Line only</button>
        </div>
      </div>
      <div class="form-actions form-actions-enhanced">
        
      <div class="form-actions-right"><button type="button" id="cancelConnectionModal" data-i18n="builder.buttons.cancel" class="button-enhanced" aria-label="Cancel">Cancel</button></div></div>
    </div>
  </div>

  <!-- Style Modal for Selected Circles -->
  <div id="styleModal" class="modal hidden modal-enhanced modal-enhanced-processed" role="dialog" aria-modal="true">
    <div class="modal-content" style="scroll-behavior: smooth; overflow-y: auto; max-height: 80vh;">
      <button class="modal-close-btn" aria-label="Close">√ó</button>
      <div class="modal-header"><h2 id="styleModalTitle" data-i18n="builder.modals.style.title">Style Selected Circles</h2></div>
      <div class="modal-body">
        <form id="styleForm">
          <!-- Node Settings -->
          <div class="setting-section">
            <h4 data-i18n="builder.settings.node_appearance">Node Appearance</h4>
            <div class="setting-group">
              <label for="selectedNodeColor" data-i18n="builder.settings.node_color">Node Color:</label>
              <input type="color" id="selectedNodeColor" value="#3498db">
            </div>
            <div class="setting-group">
              <label for="selectedNodeSize" data-i18n="builder.settings.node_size">Node Size:</label>
              <input type="number" id="selectedNodeSize" min="10" max="100" value="40">
            </div>
          </div>

          <!-- Font Settings -->
          <div class="setting-section">
            <h4 data-i18n="builder.settings.text_settings">Text Settings</h4>
            <div class="setting-group">
              <label for="selectedFont" data-i18n="builder.settings.font">Font:</label>
              <select id="selectedFont">
                <optgroup label="Modern Sans-Serif">
                  <option value="Inter">Inter</option>
                  <option value="Roboto">Roboto</option>
                  <option value="Lato">Lato</option>
                  <option value="Montserrat">Montserrat</option>
                  <option value="Poppins">Poppins</option>
                  <option value="Open Sans">Open Sans</option>
                </optgroup>
                <optgroup label="Serif">
                  <option value="Merriweather">Merriweather</option>
                  <option value="Playfair Display">Playfair Display</option>
                  <option value="Roboto Slab">Roboto Slab</option>
                </optgroup>
                <optgroup label="Monospace">
                  <option value="Courier New">Courier New</option>
                  <option value="Roboto Mono">Roboto Mono</option>
                </optgroup>
              </select>
            </div>
            <div class="setting-group">
              <label for="selectedFontSize" data-i18n="builder.settings.font_size">Font Size:</label>
              <input type="number" id="selectedFontSize" min="6" max="72" value="14">
            </div>
            <div class="setting-group">
              <label for="selectedNameColor" data-i18n="builder.settings.name_color">Name Color:</label>
              <input type="color" id="selectedNameColor" value="#333333">
            </div>
            <div class="setting-group">
              <label for="selectedDateColor" data-i18n="builder.settings.date_color">Date Color:</label>
              <input type="color" id="selectedDateColor" value="#757575">
            </div>
          </div>
        </form>
      </div>
      <div class="form-actions form-actions-enhanced">
        
        
      <div class="form-actions-right"><button type="button" id="cancelStyleModal" data-i18n="builder.buttons.cancel" class="button-enhanced" aria-label="Cancel">Cancel</button><button type="submit" id="applySelectedStyle" data-i18n="builder.settings.apply" class="button-enhanced" aria-label="Apply">Apply</button></div></div>
    </div>
  </div>

<!-- Person Modal (Enhanced with Radio Buttons, Sticky Buttons, and Delete) -->
  <div id="personModal" class="modal hidden" style="display: none;" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button class="modal-close-btn" aria-label="Close">√ó</button>
      <h2 id="modalTitle" data-i18n="builder.modals.person.add_title">Add Person</h2>
      <div class="modal-body">
        <form id="personForm">
          <!-- Gender Radio Buttons at Top -->
          <div class="form-group">
            <label data-i18n="builder.form.gender">Gender</label>
            <div class="gender-radio-group">
              <div class="gender-radio-option">
                <input type="radio" id="genderMale" name="personGender" value="male" required="">
                <label for="genderMale" data-i18n="builder.form.gender_male">Male</label>
              </div>
              <div class="gender-radio-option">
                <input type="radio" id="genderFemale" name="personGender" value="female" required="">
                <label for="genderFemale" data-i18n="builder.form.gender_female">Female</label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="personName" data-i18n="builder.form.given_name">Given Name</label>
            <input type="text" id="personName" required="">
          </div>
          <div class="form-group">
            <label for="personFatherName" data-i18n="builder.form.father_name">Father's Name</label>
            <input type="text" id="personFatherName" placeholder="Father&#39;s given name" data-i18n="builder.form.father_name_placeholder">
            <small class="help-text" data-i18n="builder.form.father_name_help">Father's given name (not surname)</small>
          </div>
          <div class="form-group">
            <label for="personSurname" data-i18n="builder.form.surname">Surname</label>
            <input type="text" id="personSurname">
          </div>
          <div class="form-group">
            <label for="personMaidenName" data-i18n="builder.form.maiden_name">Maiden Name</label>
            <input type="text" id="personMaidenName">
          </div>
          <div class="form-group">
            <label for="personDob" data-i18n="builder.form.date_of_birth">Date of Birth</label>
            <input type="text" id="personDob" placeholder="dd.mm.yyyy or yyyy" data-i18n="builder.form.dob_placeholder">
            <small class="help-text" data-i18n="builder.form.dob_help">Enter full date dd.mm.yyyy or just year yyyy</small>
          </div>
          <div class="form-group">
            <label data-i18n="builder.form.mother">Mother</label>
            <div class="searchable-select" id="motherSelect"></div>
          </div>
          <div class="form-group">
            <label data-i18n="builder.form.father">Father</label>
            <div class="searchable-select" id="fatherSelect"></div>
          </div>
          <div class="form-group">
            <label data-i18n="builder.form.spouse">Spouse</label>
            <div class="searchable-select" id="spouseSelect"></div>
          </div>
        </form>
      </div>
      <div class="form-actions">
        <button type="button" id="deletePersonBtn" class="btn-danger hidden" data-i18n="builder.buttons.delete">Delete</button>
        <div class="form-actions-right">
          <button type="button" id="cancelModal" data-i18n="builder.buttons.cancel">Cancel</button>
          <button type="submit" id="savePerson" data-i18n="builder.buttons.save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- i18n Script -->
  <script src="./index_files/i18n.js.download"></script>
  <!-- Language Switcher -->
  <script src="./index_files/language-switcher.js.download"></script>
  
  <!-- Scripts as ES modules -->
  <script type="module" src="./index_files/searchableSelect.js.download"></script>
  <script type="module" src="./index_files/modal.js.download"></script>
  <script type="module" src="./index_files/tree.js.download"></script>
  <script type="module" src="./index_files/table.js.download"></script>
  <script type="module" src="./index_files/exporter.js.download"></script>
  <script type="module" src="./index_files/notifications.js.download"></script>
  <script type="module" src="./index_files/search.js.download"></script>
  
  <script type="module">
    import { rebuildTableView } from './src/ui/components/table.js';
    
    // Enhanced App Initialization with i18n support
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üåç Initializing family tree builder with i18n...');
      
      // Initialize i18n first
      if (window.i18n) {
        try {
          await window.i18n.init();
          console.log('‚úÖ i18n initialized in builder');
        } catch (error) {
          console.error('‚ùå i18n initialization failed:', error);
        }
      }
      
      // Setup drag and drop for file import
      setupDragAndDrop();
      
      // Setup cache indicator updates
      setupCacheIndicator();
      
      // Wait for tree core to be ready, then initialize sidebar
      setTimeout(() => {
        initializeSidebar();
        initializeEnhancedSettings();
        initializeEnhancedCacheIndicator();
      }, 1000);
      
      // Initialize tutorial system - DISABLED
      // console.log('About to initialize tutorial...');
      // await initializeTutorial();
      // console.log('Tutorial initialization complete');
      
      // Add debug controls if needed - DISABLED
      // addTutorialControls();
      // console.log('Debug controls added');
    });
    
    function setupDragAndDrop() {
      const importExportArea = document.getElementById('importExportArea');
      if (!importExportArea) return;
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        importExportArea.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        importExportArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        importExportArea.addEventListener(eventName, unhighlight, false);
      });
      
      function highlight(e) {
        importExportArea.classList.add('dragover');
      }
      
      function unhighlight(e) {
        importExportArea.classList.remove('dragover');
      }
      
      importExportArea.addEventListener('drop', handleDrop, false);
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          const file = files[0];
          if (file.type === 'application/json' || file.name.endsWith('.json')) {
            // Trigger the file input change event
            const loadDataInput = document.getElementById('loadData');
            if (loadDataInput) {
              // Create a new FileList
              const fileList = new DataTransfer();
              fileList.items.add(file);
              loadDataInput.files = fileList.files;
              
              // Trigger change event
              const event = new Event('change', { bubbles: true });
              loadDataInput.dispatchEvent(event);
            }
          } else {
            import('./notifications.js').then(({ notifications }) => {
              const errorTitle = window.i18n ? window.i18n.t('builder.notifications.invalid_file') : 'Invalid File';
              const errorMessage = window.i18n ? window.i18n.t('builder.notifications.drop_json') : 'Please drop a JSON file';
              notifications.error(errorTitle, errorMessage);
            });
          }
        }
      }
    }
    
    function setupCacheIndicator() {
      // Update cache indicator based on system state
      const cacheIndicator = document.getElementById('cacheIndicator');
      if (!cacheIndicator) return;
      
      // Listen for save events
      window.addEventListener('storage', (e) => {
        if (e.key && e.key.includes('familyTreeCanvas')) {
          const saveIndicator = document.getElementById('saveIndicator');
          if (saveIndicator) {
            const savedText = window.i18n ? window.i18n.t('builder.cache.saved') : 'Saved';
            saveIndicator.textContent = `${savedText}: ${new Date().toLocaleTimeString()}`;
            cacheIndicator.classList.add('saving');
            
            setTimeout(() => {
              cacheIndicator.classList.remove('saving');
            }, 2000);
          }
        }
      });
      
      // Check for cached data on load
      setTimeout(() => {
        const cachedData = localStorage.getItem('familyTreeCanvas_state');
        if (cachedData) {
          const saveIndicator = document.getElementById('saveIndicator');
          if (saveIndicator) {
            try {
              const data = JSON.parse(cachedData);
              const lastSave = new Date(data.timestamp);
              const lastSavedText = window.i18n ? window.i18n.t('builder.cache.last_saved') : 'Last saved';
              saveIndicator.textContent = `${lastSavedText}: ${lastSave.toLocaleTimeString()}`;
            } catch (error) {
              const cachedText = window.i18n ? window.i18n.t('builder.cache.cached_available') : 'Cached data available';
              saveIndicator.textContent = cachedText;
            }
          }
        }
      }, 2000);
    }

    // Enhanced Cache Indicator Class
    function initializeEnhancedCacheIndicator() {
      class EnhancedCacheIndicator {
        constructor() {
          this.indicator = document.getElementById('cacheIndicator');
          this.saveIndicator = document.getElementById('saveIndicator');
          this.treeNameInput = document.getElementById('treeNameInput');
          this.personCount = document.getElementById('personCount');
          this.connectionCount = document.getElementById('connectionCount');
          this.autoSaveStatus = document.getElementById('autoSaveStatus');
          this.expandTimeout = null;
          this.isExpanded = false;
          
          this.init();
        }
        
        init() {
          if (this.indicator) {
            this.indicator.addEventListener('click', () => this.toggleExpand());
            this.indicator.addEventListener('mouseleave', () => this.scheduleCollapse());
            
            // Prevent collapse when hovering over expanded content
            this.indicator.addEventListener('mouseenter', () => {
              if (this.expandTimeout) {
                clearTimeout(this.expandTimeout);
                this.expandTimeout = null;
              }
            });
            
            // Prevent clicks on expanded content from closing the panel
            const expandedContent = this.indicator.querySelector('.cache-expanded-content');
            if (expandedContent) {
              expandedContent.addEventListener('click', (e) => {
                e.stopPropagation();
                this.clearCollapseTimer(); // Clear timer when clicking anywhere in expanded content
              });
              
              // Also clear timer when mouse enters expanded content
              expandedContent.addEventListener('mouseenter', () => {
                this.clearCollapseTimer();
              });
            }
          }
          
          if (this.treeNameInput) {
            this.treeNameInput.addEventListener('change', () => this.saveTreeName());
            
            // Prevent click events from bubbling up to parent (which would close the panel)
            this.treeNameInput.addEventListener('click', (e) => {
              e.stopPropagation();
              this.clearCollapseTimer(); // Clear timer when clicking input
            });
            
            // Also prevent focus events from triggering parent click
            this.treeNameInput.addEventListener('focus', (e) => {
              e.stopPropagation();
              this.clearCollapseTimer(); // Clear timer when focusing input
            });
            
            // Clear timer while user is typing
            this.treeNameInput.addEventListener('input', () => {
              this.clearCollapseTimer();
            });
            
            // Clear timer while user is actively in the input field
            this.treeNameInput.addEventListener('keydown', () => {
              this.clearCollapseTimer();
            });
            
            // Only start collapse timer when user leaves the input field
            this.treeNameInput.addEventListener('blur', () => {
              this.saveTreeName();
              this.scheduleCollapse(2000); // Give some time after losing focus
            });
          }
          
          this.updateStats();
          this.loadTreeName();
        }
        
        toggleExpand() {
          this.isExpanded = !this.isExpanded;
          
          if (this.isExpanded) {
            this.indicator.classList.add('expanded');
            this.updateStats();
            this.scheduleCollapse(4000); // Auto-collapse after 4 seconds
          } else {
            this.indicator.classList.remove('expanded');
            if (this.expandTimeout) {
              clearTimeout(this.expandTimeout);
              this.expandTimeout = null;
            }
          }
        }
        
        scheduleCollapse(delay = 500) {
          if (this.expandTimeout) {
            clearTimeout(this.expandTimeout);
          }
          
          this.expandTimeout = setTimeout(() => {
            if (this.isExpanded) {
              this.isExpanded = false;
              this.indicator.classList.remove('expanded');
            }
          }, delay);
        }
        
        clearCollapseTimer() {
          if (this.expandTimeout) {
            clearTimeout(this.expandTimeout);
            this.expandTimeout = null;
          }
        }
        
        updateStats() {
          // Get stats from tree core if available
          if (window.treeCore) {
            const personCount = window.treeCore.renderer?.nodes.size || 0;
            const connectionCount = window.treeCore.renderer?.connections.length || 0;
            
            if (this.personCount) this.personCount.textContent = personCount;
            if (this.connectionCount) this.connectionCount.textContent = connectionCount;
          }
        }
        
        saveTreeName() {
          if (this.treeNameInput) {
            const treeName = this.treeNameInput.value.trim() || 'My Family Tree';
            localStorage.setItem('familyTree_treeName', treeName);
          }
        }
        
        loadTreeName() {
          const savedName = localStorage.getItem('familyTree_treeName') || 'My Family Tree';
          if (this.treeNameInput) {
            this.treeNameInput.value = savedName;
          }
        }
        
        updateSaveStatus(status, time) {
          if (this.saveIndicator) {
            this.saveIndicator.textContent = `${status}: ${time}`;
          }
        }
      }

      // Initialize the enhanced cache indicator
      window.enhancedCacheIndicator = new EnhancedCacheIndicator();
    }
    
    let currentView = 'graphic';
    
    function initializeSidebar() {
      console.log('Initializing enhanced sidebar...');
      
      // Home button
      const homeBtn = document.getElementById('homeBtn');
      if (homeBtn) {
        homeBtn.addEventListener('click', () => {
          console.log('Home button clicked');
          window.location.href = 'index.html';
        });
        console.log('Home button initialized');
      }

      // Center selected button
      const centerSelectedBtn = document.getElementById('centerSelectedBtn');
      if (centerSelectedBtn) {
        centerSelectedBtn.addEventListener('click', () => {
          console.log('Center selected button clicked');
          const treeCore = window.treeCore;
          if (treeCore && typeof treeCore.centerSelectedNode === 'function') {
            treeCore.centerSelectedNode();
          } else {
            console.error('Tree core not available for centering');
            notifications.error('Tree Core Not Ready', 'Please wait for the family tree to load completely');
          }
        });
        console.log('Center selected button initialized');
      }
      
      // Zoom buttons - improved to work with canvas
      const zoomInBtn = document.getElementById('zoomInBtn');
      if (zoomInBtn) {
        zoomInBtn.addEventListener('click', () => {
          console.log('Zoom in button clicked');
          triggerCanvasZoom(-100);
        });
        console.log('Zoom in button initialized');
      }
      
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      if (zoomOutBtn) {
        zoomOutBtn.addEventListener('click', () => {
          console.log('Zoom out button clicked');
          triggerCanvasZoom(100);
        });
        console.log('Zoom out button initialized');
      }
      
      // Settings toggle
      const settingsToggle = document.getElementById('settingsToggle');
      const settingsPanel = document.getElementById('settingsPanel');
      
      if (settingsToggle && settingsPanel) {
        settingsToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          console.log('Settings toggle clicked');
          const isHidden = settingsPanel.classList.contains('hidden');
          settingsPanel.classList.toggle('hidden');
          settingsToggle.classList.toggle('active');
          console.log('Settings panel', isHidden ? 'opened' : 'closed');
        });
        
        // Close settings when clicking outside
        document.addEventListener('click', (e) => {
          if (!settingsPanel.contains(e.target) && !settingsToggle.contains(e.target)) {
            if (!settingsPanel.classList.contains('hidden')) {
              settingsPanel.classList.add('hidden');
              settingsToggle.classList.remove('active');
            }
          }
        });
        
        console.log('Settings toggle initialized');
      }
      
      // View toggle
      const viewToggle = document.getElementById('viewToggle');
      if (viewToggle) {
        viewToggle.addEventListener('click', () => {
          console.log('View toggle clicked');
          toggleView();
        });
        console.log('View toggle initialized');
      }
    }
    
    function triggerCanvasZoom(deltaY) {
      console.log('Triggering canvas zoom:', deltaY);
      
      const graphicView = document.getElementById('graphicView');
      const canvas = graphicView?.querySelector('canvas');
      
      if (canvas) {
        console.log('Found canvas, triggering zoom');
        const rect = canvas.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        const wheelEvent = new WheelEvent('wheel', {
          deltaY: deltaY,
          clientX: centerX,
          clientY: centerY,
          bubbles: true,
          cancelable: true
        });
        
        canvas.dispatchEvent(wheelEvent);
      } else {
        console.log('Canvas not found, trying SVG fallback');
        const svgArea = document.getElementById('svgArea');
        if (svgArea) {
          const rect = svgArea.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          const wheelEvent = new WheelEvent('wheel', {
            deltaY: deltaY,
            clientX: centerX,
            clientY: centerY,
            bubbles: true,
            cancelable: true
          });
          
          svgArea.dispatchEvent(wheelEvent);
        }
      }
    }
    
    function toggleView() {
      console.log('Toggling view from:', currentView);
      
      const graphicView = document.getElementById('graphicView');
      const tableView = document.getElementById('tableView');
      const viewToggle = document.getElementById('viewToggle');
      
      if (!graphicView || !tableView || !viewToggle) {
        console.error('View elements not found');
        return;
      }
      
      const icon = viewToggle.querySelector('svg');
      
      if (currentView === 'graphic') {
        // Switch to table view
        currentView = 'table';
        tableView.classList.remove('hidden');
        graphicView.classList.add('hidden');
        viewToggle.classList.add('active');
        
        // Update icon
        if (icon) {
          icon.innerHTML = `
            <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" fill="currentColor" stroke="none"/>
          `;
        }
        
        // Rebuild table
        setTimeout(() => {
          rebuildTableView();
        }, 100);
        
      } else {
        // Switch to graphic view
        currentView = 'graphic';
        graphicView.classList.remove('hidden');
        tableView.classList.add('hidden');
        viewToggle.classList.remove('active');
        
        // Update icon
        if (icon) {
          icon.innerHTML = `
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          `;
        }
        
        // Refresh canvas
        setTimeout(() => {
          import('./tree.js').then(() => {
            console.log('Canvas refreshed after view switch');
          });
        }, 100);
      }
      
      console.log('Switched to view:', currentView);
    }
    
    function initializeEnhancedSettings() {
      console.log('Initializing enhanced settings...');
      
      // Collapsible sections
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', () => {
          const targetId = header.getAttribute('data-target');
          const content = document.getElementById(targetId);
          
          if (content) {
            const isExpanded = content.classList.contains('expanded');
            content.classList.toggle('expanded');
            header.classList.toggle('expanded');
            console.log(`Toggled section ${targetId}:`, !isExpanded);
          }
        });
      });
      
      console.log('Enhanced settings initialized');
    }

    // Initialize Simple Tutorial System
    async function initializeTutorial() {
      try {
        const SimpleTutorial = await import('./src/tutorial/SimpleTutorial.js');
        const TutorialClass = SimpleTutorial.default;
        
        // Create global tutorial class reference
        window.SimpleTutorial = TutorialClass;
        
        console.log('SimpleTutorial class:', TutorialClass);
        
        // Auto-start tutorial for new users
        if (TutorialClass.shouldAutoStart()) {
          setTimeout(() => {
            const tutorial = new TutorialClass();
            tutorial.start();
            window.currentTutorial = tutorial; // For debugging
          }, 1500); // Wait for page to fully load
        }
        
        console.log('Simple tutorial system initialized');
      } catch (error) {
        console.warn('Tutorial system failed to initialize:', error);
        console.error(error);
      }
    }

    // Add tutorial control buttons (optional - for testing/admin)
    function addTutorialControls() {
      if (window.location.search.includes('debug') || window.location.search.includes('tutorial')) {
        const controls = document.createElement('div');
        controls.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          z-index: 100001;
          background: white;
          padding: 10px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          display: flex;
          gap: 8px;
        `;
        
        controls.innerHTML = `
          <button onclick="startTutorialManually()" style="padding: 4px 8px; font-size: 12px;">Start Tutorial</button>
          <button onclick="localStorage.removeItem('family-tree-tutorial-completed')" style="padding: 4px 8px; font-size: 12px;">Reset Progress</button>
        `;
        
        // Add manual start function to global scope
        window.startTutorialManually = function() {
          if (window.SimpleTutorial) {
            const tutorial = new window.SimpleTutorial();
            tutorial.start();
          } else {
            alert('Tutorial not loaded yet');
          }
        };
        
        document.body.appendChild(controls);
      }
    }

    // Tutorial initialization moved to main DOMContentLoaded above
  </script>
  
  <!-- Font loading optimization -->
  <script>
    // Prevent FOUC and enable animations after fonts load
    document.addEventListener('DOMContentLoaded', function() {
      // Check if fonts are loaded
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(function() {
          document.body.classList.remove('no-animations');
          document.body.classList.add('fonts-loaded');
        });
      } else {
        // Fallback for browsers without font loading API
        setTimeout(function() {
          document.body.classList.remove('no-animations');
          document.body.classList.add('fonts-loaded');
        }, 100);
      }
    });
  </script>


<a href="https://www.mapmyroots.com/builder.html#main-content" class="skip-link" style="position: absolute; top: -40px; left: 6px; background: rgb(0, 0, 0); color: white; padding: 8px; text-decoration: none; z-index: 10000; border-radius: 4px;">Skip to main content</a></body></html>